<script>
async function showWarehouse(name) {
  const sheetName = warehouseSheets[name];
  const { headers, data } = await fetchWarehouseData(sheetName);

  // Display warehouse heading
  const heading = document.getElementById("warehouseName");
  heading.innerText = name + " Warehouse";

  // Create / update Last Synced element
  let syncedElem = document.getElementById("lastSynced");
  if (!syncedElem) {
    syncedElem = document.createElement("div");
    syncedElem.id = "lastSynced";
    syncedElem.style.fontSize = "16px";
    syncedElem.style.fontWeight = "500";
    syncedElem.style.marginBottom = "10px";
    heading.parentNode.insertBefore(syncedElem, heading.nextSibling);
  }

  // Find index of 'Synced at' column
  const syncedAtIndex = headers.indexOf("Synced at");
  let syncedDate = "";
  if (syncedAtIndex !== -1 && data.length > 0) {
    const firstValue = data[0][syncedAtIndex];
    if (firstValue) {
      const dateObj = new Date(firstValue);
      const dd = String(dateObj.getDate()).padStart(2, '0');
      const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
      const yyyy = dateObj.getFullYear();
      syncedDate = `${dd}-${mm}-${yyyy}`;
    }
  }

  // Display Last Synced below heading
  syncedElem.innerText = "Last Synced: " + syncedDate;

  const table = document.querySelector("#warehouse table");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");

  if (data.length === 0) {
    thead.innerHTML = "";
    tbody.innerHTML = `<tr><td colspan="${headers.length}">No data available</td></tr>`;
    document.getElementById("home").classList.add("hidden");
    document.getElementById("inventory").classList.add("hidden");
    document.getElementById("warehouse").classList.remove("hidden");
    return;
  }

  // Remove 'Synced at' from headers and add Days to Stockout
  const displayHeaders = headers.filter(h => h !== "Synced at");
  displayHeaders.push("Days to Stockout");

  thead.innerHTML = "<tr>" + displayHeaders.map(h => `<th>${h}</th>`).join("") + "</tr>";

  tbody.innerHTML = "";
  data.forEach(row => {
    // Remove Synced at value
    const displayRow = row.filter((_, idx) => idx !== syncedAtIndex);

    // Calculate Days to Stockout
    let daysStockout = "N/A";
    try {
      let available = 0;
      let last30Sale = 0;

      if (name === "Amazon") {
        available = parseFloat(row[headers.indexOf("Total Inventory")]) || 0;
      } else {
        available = parseFloat(row[headers.indexOf("Available")]) || 0;
      }
      last30Sale = parseFloat(row[headers.indexOf("Last 30 days sale")]) || 0;

      if (last30Sale > 0) {
        daysStockout = ((available * 30) / last30Sale).toFixed(1);
      }
    } catch (e) {
      daysStockout = "N/A";
    }

    displayRow.push(daysStockout);

    // Build table row HTML
    let rowHTML = "<tr>";
    displayRow.forEach((cell, idx) => {
      // Apply color for Days to Stockout (last column)
      if (idx === displayRow.length - 1 && daysStockout !== "N/A") {
        let threshold = (name === "Amazon") ? 20 : 10;
        let color = (parseFloat(daysStockout) < threshold) ? "#FF4D4F" : "#333";
        rowHTML += `<td style="color:${color}; font-weight:600;">${cell}</td>`;
      } else {
        rowHTML += `<td>${cell}</td>`;
      }
    });
    rowHTML += "</tr>";

    tbody.innerHTML += rowHTML;
  });

  document.getElementById("home").classList.add("hidden");
  document.getElementById("inventory").classList.add("hidden");
  document.getElementById("warehouse").classList.remove("hidden");
}
</script>
